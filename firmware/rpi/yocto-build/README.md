# Building RATT Image with Yocto/OpenEmbedded and Mender

Based on http://www.jumpnowtek.com/rpi/Raspberry-Pi-Systems-with-Yocto.html
Mender info at https://docs.mender.io/

## Pre-requisites

Start with Ubuntu 18.04.1 LTS image running in a virtual machine.  Make sure you have enough disk space (at LEAST 50GB, preferably more).  If you are
doing a lot of building, you will want this on fast disk (SSD).  You will also want to give the Virtual Machine a lot of RAM and CPU cores if you can.
I run with 16GB and 12 cores dedicated to the VM for faster builds.

### Set up a work directory in `/u` (with `/tmp`-like permissions)

    sudo mkdir /u
    sudo chmod 777 /u
    sudo chmod o+t /u

### Install some pre-requisites for building:

    sudo apt install python rename build-essential chrpath diffstat gawk libncurses5-dev texinfo python2.7 git python3-setuptools

### Ensure python2.7 has links (18.04.1 did not until 'python' package installed):

    steve@ubuntu:~$ ls -al /usr/bin/python
    lrwxrwxrwx 1 root root 9 Feb  8 05:47 /usr/bin/python -> python2.7
    steve@ubuntu:~$ ls -al /usr/bin/python2
    lrwxrwxrwx 1 root root 9 Feb  8 05:47 /usr/bin/python2 -> python2.7

### Ensure 'dash' is disabled on Ubuntu:
    sudo dpkg-reconfigure dash

Choose No to dash when prompted.

### Clone the RATT repo from github

Some directories have fixed paths with `${HOME}` references for the Yocto build, so it is necessary to clone it into your home directory, i.e. `~/ratt` - do not place it inside of other directories or in other locations.

    cd ~
    git clone https://github.com/makeitlabs/ratt.git

### Check that the `meta-ratt` submodule was initialized

Some versions of git will not automatically initialize submodules.  If `~/ratt/firmware/rpi/meta-ratt` is empty after your initial git clone, do this:

    cd ~/ratt/firmware/rpi
    git submodule update --init --recursive

_The `meta-ratt` is included as a submodule because it's forked from the `meta-rpi` project and for ease of maintainance I want to keep it
separate from the rest of RATT._  `meta-ratt` is essentially the layer that defines how to build Yocto exactly for our RATT platform.  It
stands on the shoulders of a lot of work from others for Raspberry Pi compatibility, and makes only specific tweaks where necessary to adjust
the build to our needs.

### Make a local clone of the Yocto poky-sumo branch from github

Poky is the name of the reference build of Yocto Project.  Sumo is the branch that RATT is based on, and was released in April of 2018.
See https://www.yoctoproject.org/software-overview/downloads/ for more info about the release.

I've included a script to do the dirty work of cloning Poky-Sumo.  This script will also set up a couple of directories in
/u/rpi that the build process will use for the downloaded sources cache as well as the temporary build directory.

    ~/ratt/firmware/rpi/yocto-build/scripts/setup-poky-build.sh

**TODO: Maybe adjust the script to tie to specific SHAs for poky-sumo and its dependencies so we're not chasing updates.**
   

## Building

### Source the yocto environment before running bitbake

    source /u/rpi/poky-sumo/oe-init-build-env ~/ratt/firmware/rpi/yocto-build

_Ignore the common suggested build target text that is spit out here - we don't build those targets for RATT._

### Start a build of the RATT image

    bitbake ratt-image

_Wait a long time..._  2-3 hours typically.  More RAM, faster disk, and more/faster cores will help but it's building a lot of stuff.  Yocto Project does a good job at determining deltas and dependencies, so subsequent builds of small changes are comparably much quicker.

## Copying to SD Card

(Note: this section needs to be updated to reflect changes in the image now that Mender is integrated -- the following info is out of date)

### Configuration

If you want WLAN to come up and automatically connect to your access point, you must set up a the `wpa_supplicant.conf`
file before you deploy the image to the SD card.  There is template config included.  Copy this file to `wpa_supplicant.conf` in the
same `scripts` directory, and edit it to set up your access point.  A pre-configured file is not provided in the repository
for obvious security reasons.  If you do not edit this file, the WLAN will not come up automatically.

This is the template in `~/ratt/firmware/rpi/meta-ratt/scripts/wpa_supplicant.conf-example`.  Note that the critical
sections are commented out.

    ctrl_interface=/var/run/wpa_supplicant
    ap_scan=1
    
    #network={
    #    key_mgmt=WPA-PSK
    #    ssid="<ssid>"
    #    psk="<pass>"
    #}

    # open network
    #network={
    #    key_mgmt=NONE
    #    ssid="<ssid>"
    #}

    ctrl_interface=/var/run/wpa_supplicant
    ap_scan=1

Example config for a WPA-PSK network, saved to `~/ratt/firmware/rpi/meta-ratt/scripts/wpa_supplicant.conf`:

    network={
        key_mgmt=WPA-PSK
        ssid="MyNetwork"
        psk="2secure4u"
    }



# open network
    #network={
    #    key_mgmt=NONE
    #    ssid="<ssid>"
    #}


### Find the SD card device with `lsblk`

Insert the SD card into your USB reader, and make sure the USB device is attached to the Virtual Machine.  You can usually see
the device via kernel messages in `dmesg` but the `lsblk` program will also list out all block devices and partition sizes.

    NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
    sdf      8:80   1  3.7G  0 disk
    ├─sdf1   8:81   1   64M  0 part 
    └─sdf2   8:82   1  3.6G  0 part 
    sr0     11:0    1 1024M  0 rom  
    sda      8:0    0  100G  0 disk 
    ├─sda2   8:2    0    1K  0 part 
    ├─sda5   8:5    0    8G  0 part [SWAP]
    └─sda1   8:1    0   92G  0 part /

_SD device is `/dev/sdf` in the above example, but it will likely appear as a different device on your machine!_

### Make Partitions

Use the meta-rpi script to make the two necessary partitions on the SD card (need to know device above).

    cd ~/ratt/firmware/rpi/meta-ratt/scripts

sudo ./mk2parts.sh sdf

### Make a temporary mount point

Some of the utility scripts have this mount point hard coded, so make sure it exists.

    sudo mkdir /media/card

### Copy boot partition:

_Note, replace `sdf` with your actual SD card device, and be careful!_

    source ./ratt_card_env.sh
    ./copy_boot.sh sdf

### Copy root filesystem:

_Note, replace `sdf` with your actual SD card device, and be careful!_

    ./copy_rootfs.sh sdf ratt ratt-test

This script takes several args:
    copy_rootfs.sh [SD device] [image name minus the -image] [hostname]


Note: This can be pretty slow to finish (minutes to potentially tens of minutes depending on quality of card and speed of your card reader/writer).

# Yocto / OpenEmbedded References

## Writing Recipes

  * http://www.yoctoproject.org/docs/current/dev-manual/dev-manual.html#new-recipe-writing-a-new-recipe
  * https://wiki.yoctoproject.org/wiki/Building_your_own_recipes_from_first_principles
  * http://www.embeddedlinux.org.cn/OEManual/directories_installation.html
  * http://www.embeddedlinux.org.cn/OEManual/recipes_directories.html
  * https://elinux.org/Bitbake_Cheat_Sheet
  
  
